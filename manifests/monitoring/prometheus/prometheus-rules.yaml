apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  wordpress-alerts.yaml: |
    groups:
    - name: wordpress.availability
      rules:
      - alert: WordpressMysqlDown
        expr: kube_deployment_spec_replicas{namespace="wordpress", deployment="mysql"} > 0 and kube_deployment_status_replicas_available{namespace="wordpress", deployment="mysql"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "MySQL deployment unavailable"
          description: "wordpress/mysql has 0 available replicas for more than 2 minutes."
      - alert: WordpressPhpMyAdminDown
        expr: kube_deployment_spec_replicas{namespace="wordpress", deployment="phpmyadmin"} > 0 and kube_deployment_status_replicas_available{namespace="wordpress", deployment="phpmyadmin"} == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "phpMyAdmin deployment unavailable"
          description: "wordpress/phpmyadmin has 0 available replicas for more than 2 minutes."
      - alert: WordpressSiteDown
        expr: kube_deployment_spec_replicas{namespace="wordpress", deployment="wordpress"} > 0 and kube_deployment_status_replicas_available{namespace="wordpress", deployment="wordpress"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "WordPress deployment unavailable"
          description: "wordpress/wordpress has 0 available replicas for more than 2 minutes."
      - alert: WordpressEndpointDown
        expr: probe_success{job="wordpress-blackbox"} == 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Public WordPress endpoint is unreachable"
          description: "Blackbox probe to https://usemirai.site/ failed."
